{% load static %}
<!doctype html>
{% load pwa %}
<html lang="en">
<head>
  {% progressive_web_app_meta %}
  <title>Bathroom Access: Find public restrooms near you in Greater Boston</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" type="text/css" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css">
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.css">
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.Default.css">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous">

  <style>
    html, body {
      height: 100%;
      margin: 0;
    }

    #map {
      width: 100%;
      height: 70vh;
      min-height: 400px;
      position: relative;
      z-index: 1;
      background: #e5e3df;
    }

    .legend {
      line-height: 18px;
      color: #000000;
      background-color: #ffffffcc;
      padding: 1em;
    }
    .legend i {
      width: 18px;
      height: 18px;
      float: left;
      margin-right: 8px;
      opacity: 0.7;
    }
  </style>
  </style>
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-FBRC7LKLBW"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'G-FBRC7LKLBW');
  </script>
</head>
<body>
  {{ markers|json_script:"markers-data" }}
  <div id="map"></div>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-ka7Sk0Gln4gmtz2MlQnikT1wXgYsOg+OMhuP+IlRH9sENBO0LRn5q+8nbTov4+1p" crossorigin="anonymous"></script>
  <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet.markercluster@1.4.1/dist/leaflet.markercluster.js"></script>
  <script src="https://kit.fontawesome.com/66634f6c24.js" crossorigin="anonymous"></script>
  <script>
  (function() {
    try {
      if (typeof L === 'undefined') {
        var el = document.getElementById('map');
        if (el) el.innerHTML = '<div style="padding:2em;color:#c00;">Leaflet failed to load.</div>';
        return;
      }
      var mapEl = document.getElementById('map');
      if (!mapEl) return;
      var map = L.map('map', {tap: false});
      map.setView([42.36, -71.06], 10);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
      }).addTo(map);
      var markersData = [];
      var markersEl = document.getElementById('markers-data');
      if (markersEl) { try { markersData = JSON.parse(markersEl.textContent); } catch(e) { markersData = []; } }
      if (!Array.isArray(markersData)) markersData = [];
      var markerGroup = (L.markerClusterGroup ? L.markerClusterGroup({ chunkedLoading: true }) : L.featureGroup()).addTo(map);
      function render(m) {
        var r = (m.remarks || '').replace(/(?:\r\n|\r|\n)/g, '<br>');
        return "<h3>" + (m.name || '') + "</h3><br><b>Address</b>: <a target=\"_blank\" href=\"https://www.google.com/maps/search/?api=1&query=" + m.latitude + "%2C" + m.longitude + "\">" + (m.address || '') + "</a><br><b>Hours</b>: " + (m.hours || '') + "<br><b>Remarks</b>: " + r;
      }
      for (var i = 0; i < markersData.length; i++) {
        var m = markersData[i];
        var lat = parseFloat(m.latitude), lon = parseFloat(m.longitude);
        if (isNaN(lat) || isNaN(lon) || lat < -90 || lat > 90 || lon < -180 || lon > 180) continue;
        var markerColor = 'marker-icon-2x-green.png';
        var sr = (m.remarks || '').toLowerCase(), sn = (m.name || '').toLowerCase();
        if (sr.includes('portapotty') || sr.includes('seasonal')) markerColor = 'marker-icon-2x-yellow.png';
        else if (sr.includes('inaccessible') || sr.includes('fare control') || sn.includes('school')) markerColor = 'marker-icon-2x-red.png';
        var icon = L.icon({
          iconUrl: "https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/" + markerColor,
          shadowUrl: "https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png",
          iconSize: [25, 41], iconAnchor: [12, 41], popupAnchor: [1, -34], shadowSize: [41, 41]
        });
        L.marker([lat, lon], {icon: icon}).bindPopup(render(m)).addTo(markerGroup);
      }
      function renderWithoutLocation() {
        if (markerGroup.getBounds && markerGroup.getBounds().isValid && markerGroup.getBounds().isValid()) {
          map.fitBounds(markerGroup.getBounds(), { maxZoom: 15, padding: [100, 100] });
        } else {
          map.setView([42.36, -71.06], 10);
        }
      }
      function addMarkersToMap(data) {
        if (!data || !Array.isArray(data)) return;
        for (var i = 0; i < data.length; i++) {
          var m = data[i];
          var lat = parseFloat(m.latitude), lon = parseFloat(m.longitude);
          if (isNaN(lat) || isNaN(lon) || lat < -90 || lat > 90 || lon < -180 || lon > 180) continue;
          var markerColor = 'marker-icon-2x-green.png';
          var sr = (m.remarks || '').toLowerCase(), sn = (m.name || '').toLowerCase();
          if (sr.indexOf('portapotty') !== -1 || sr.indexOf('seasonal') !== -1) markerColor = 'marker-icon-2x-yellow.png';
          else if (sr.indexOf('inaccessible') !== -1 || sr.indexOf('fare control') !== -1 || sn.indexOf('school') !== -1) markerColor = 'marker-icon-2x-red.png';
          var icon = L.icon({
            iconUrl: "https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/" + markerColor,
            shadowUrl: "https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png",
            iconSize: [25, 41], iconAnchor: [12, 41], popupAnchor: [1, -34], shadowSize: [41, 41]
          });
          L.marker([lat, lon], {icon: icon}).bindPopup(render(m)).addTo(markerGroup);
        }
      }
      function fetchMarkersForViewport() {
        var b = map.getBounds();
        if (!b || !b.isValid || !b.isValid()) return;
        var sw = b.getSouthWest(), ne = b.getNorthEast();
        var url = "/api/markers?sw_lat=" + sw.lat + "&sw_lon=" + sw.lng + "&ne_lat=" + ne.lat + "&ne_lon=" + ne.lng;
        var xhr = new XMLHttpRequest();
        xhr.open("GET", url);
        xhr.onload = function() {
          try {
            var resp = JSON.parse(this.responseText);
            markerGroup.clearLayers();
            if (resp.markers && resp.markers.length) addMarkersToMap(resp.markers);
          } catch (e) { console.warn("Markers fetch failed:", e); }
        };
        xhr.send();
      }
      var fetchDebounce;
      map.on("moveend", function() {
        clearTimeout(fetchDebounce);
        fetchDebounce = setTimeout(fetchMarkersForViewport, 250);
      });
      map.whenReady(function() { fetchMarkersForViewport(); });
      {% if latitude %}
      map.setView([{{ latitude }}, {{ longitude }}], 15);
      var xhr = new XMLHttpRequest();
      xhr.open("GET", "/api_ordered?latitude=" + {{ latitude }} + "&longitude=" + {{ longitude }});
      xhr.onload = function() { var el = document.getElementById("br-cards-row"); if (el) el.innerHTML = this.responseText; };
      xhr.send();
      {% else %}
      navigator.geolocation.getCurrentPosition(
        function(loc) {
          var userLatLng = L.latLng(loc.coords.latitude, loc.coords.longitude);
          map.setView(userLatLng, 15);
          L.circleMarker(userLatLng, {radius: 8}).addTo(map);
          var xhrList = new XMLHttpRequest();
          xhrList.open("GET", "/api_ordered?latitude=" + loc.coords.latitude + "&longitude=" + loc.coords.longitude);
          xhrList.onload = function() { var el = document.getElementById("br-cards-row"); if (el) el.innerHTML = this.responseText; };
          xhrList.send();
        },
        function(err) {
          renderWithoutLocation();
          var xhrFallback = new XMLHttpRequest();
          xhrFallback.open("GET", "/api_ordered?latitude=42.36&longitude=-71.06");
          xhrFallback.onload = function() { var el = document.getElementById("br-cards-row"); if (el) el.innerHTML = this.responseText; };
          xhrFallback.send();
        },
        { enableHighAccuracy: false, maximumAge: 60000, timeout: 5000 }
      );
      {% endif %}
      var legend = L.control({position: 'bottomright'});
      legend.onAdd = function() {
        var div = L.DomUtil.create('div', 'info legend');
        div.innerHTML = '<br><p><i style="background:#2AAD27"></i> Free, year-long</p><p><i style="background:#FFD326"></i> Seasonal</p><p><i style="background:#CB2B3E"></i> Fare-controlled or inaccessible</p>';
        return div;
      };
      legend.addTo(map);
      map.invalidateSize();
    } catch (err) {
      console.error('Map error:', err);
      var mapEl = document.getElementById('map');
      if (mapEl) mapEl.innerHTML = '<div style="padding:2em;background:#fee;color:#c00;">Map failed: ' + (err.message || err) + '</div>';
    }
    function initPlaceSearch() {
      var input = document.getElementById('place-search-input');
      var resultsDiv = document.getElementById('place-results');
      if (!input || !resultsDiv) return;
      var debounceTimer;
      input.addEventListener('input', function() {
        clearTimeout(debounceTimer);
        var q = input.value.trim();
        if (q.length < 2) { resultsDiv.style.display = 'none'; return; }
        debounceTimer = setTimeout(function() {
          fetch('/place_search?q=' + encodeURIComponent(q))
            .then(function(r) { return r.json(); })
            .then(function(data) {
              resultsDiv.innerHTML = '';
              if (data.results && data.results.length) {
                data.results.forEach(function(item) {
                  var a = document.createElement('a');
                  a.href = item.city ? ('/map?city=' + encodeURIComponent(item.city)) : ('/map?latitude=' + item.lat + '&longitude=' + item.lon);
                  a.className = 'list-group-item list-group-item-action';
                  a.textContent = item.display_name;
                  resultsDiv.appendChild(a);
                });
                resultsDiv.style.display = 'block';
              } else { resultsDiv.style.display = 'none'; }
            })
            .catch(function() { resultsDiv.style.display = 'none'; });
        }, 300);
      });
      input.addEventListener('blur', function() { setTimeout(function() { resultsDiv.style.display = 'none'; }, 200); });
      input.addEventListener('focus', function() { if (resultsDiv && resultsDiv.children.length) resultsDiv.style.display = 'block'; });
    }
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', initPlaceSearch);
    } else {
      initPlaceSearch();
    }
  })();
  </script>
  <div class="container-fluid">
    <div class="row">
      <div class="col">
        <nav>
          <div class="nav nav-tabs" id="nav-tab" role="tablist">
            <button class="nav-link active" id="nav-brlist-tab" data-bs-toggle="tab" data-bs-target="#nav-brlist" type="button" role="tab" aria-controls="nav-brlist" aria-selected="true">List</button>
            <button class="nav-link" id="nav-about-tab" data-bs-toggle="tab" data-bs-target="#nav-about" type="button" role="tab" aria-controls="nav-about" aria-selected="false">About</button>
            <button class="nav-link" id="nav-feedback-tab" data-bs-toggle="tab" data-bs-target="#nav-feedback" type="button" role="tab" aria-controls="nav-feedback" aria-selected="false">Media and Honors</button>
            <button class="nav-link" id="nav-resources-tab" data-bs-toggle="tab" data-bs-target="#nav-resources" type="button" role="tab" aria-controls="nav-resources" aria-selected="false">Resources and Data Sharing</button>
            <a href="https://www.twitter.com/bathroom_access"><i class="fab fa-twitter" style="font-size: 2em; margin-top: 0.2em; padding-left: 0.3em;"></i></a>
            <a href="https://www.instagram.com/bathroom_access"><i class="fab fa-instagram" style="font-size: 2em; margin-top: 0.2em; padding-left: 0.6em;"></i></a>
            <a href="mailto:publicbathroomaccess@gmail.com"><i class="fas fa-envelope" style="font-size: 2em; margin-top: 0.2em; padding-left: 0.6em;"></i></a>
          </div>
        </nav>
        <div class="tab-content" id="nav-tabContent">
          <div class="tab-pane fade show active" id="nav-brlist" role="tabpanel" aria-labelledby="nav-brlist-tab" tabindex="0">
            <br>
            <div class="row" id="town-search">
              <div class="col-md-8 col-lg-6 mx-auto">
                <div class="position-relative">
                  <input type="text" id="place-search-input" class="form-control form-control-lg" placeholder="Search towns (e.g. Boston, San Francisco, etc)..." autocomplete="off">
                  <div id="place-results" class="list-group position-absolute w-100 shadow" style="top: 100%; z-index: 1000; display: none;"></div>
                  <small class="text-muted d-block mt-1"><a href="/map">See all locations</a></small>
                </div>
              </div>
            </div>
            <br>
            <div class="row row-cols-1 row-cols-md-2 row-cols-lg-3 row-cols-xl-4 g-4" id="br-cards-row">
              {% include "list.html" %}
            </div>
          </div>
          <div class="tab-pane fade" id="nav-about" role="tabpanel" aria-labelledby="nav-about-tab" tabindex="0">
            <br>
            <p>
              My name is Amith Saligrama. I am a high school student at the Commonwealth School in Boston passionately interested in improving our local communities. My interest in developing this map began in 2020, when my grandparents began to limit their daily walks due to a lack of restroom access. I realized that there are many people like my grandparents - parents with toddlers, taxi and delivery drivers - who need access to restrooms. This is a situation that has become more challenging since COVID-19 as private businesses have become reluctant to allow non-customers into their facilities.
            </p>

            <p>
              This motivated me to create bathroomaccess.com to map and list public (not private) toilets in the Greater Boston area. I found most city websites include a list of parks, trails, and even water-filling stations, but not restrooms. However, if there are no mentions of restrooms, how inclusive are we being? Over time, my goal has become equally balanced between helping people find restrooms and advocating for our local communities to acknowledge all biological needs and be welcoming to all who use our public space.
            </p>
            
            <p>
              My work is now live on the <a href="https://www.somervillema.gov/departments/ospcd/transportation-and-infrastructure/getting-around-somerville">City of Somerville website</a> and as a layer on the <a href="
              https://www.mapsonline.net/westonma/index.html">Weston GIS maps</a>. I am currently working with the City of Cambridge's Open Data Review Board to set up a database of public restrooms. I am continuing my advocacy with other cities in the Greater Boston area to include this resource on their website.
            </p>

            <p>
              Please email me at <a href="mailto:publicbathroomaccess@gmail.com">publicbathroomaccess@gmail.com</a> if you have any general suggestions or specific public bathroom locations you may want me to add.
            </p>
          </div>
          <div class="tab-pane fade" id="nav-feedback" role="tabpanel" aria-labelledby="nav-about-tab" tabindex="0">
            <br>
            <h3>Awards</h3>
            <ul>
              <li>
                <p>
                  <b><a href="https://www.congressionalappchallenge.us/22-MA07/">Congressional App Challenge</a> for Massachusetts's 7th district (Rep. Ayanna Pressley, including Boston, Cambridge, Somerville)</b>: Recieved 12/16/22.
                </p>
              </li>
              <li>
                <p>
                  <b>Rotary Youth Leadership Award (<a href="https://www.westonwaylandrotary.com/page/ryla">RYLA</a>) for Weston and Wayland</b>: Recieved 10/19/21.
                </p>
              </li>
            </ul>
            <h3>Media coverage</h3>
            <ul>
              <li>
                <p>
                  <b>Cambridge Day (04/06/2023): </b> <a href="https://www.cambridgeday.com/2023/04/06/better-restroom-access-can-help-municipalities-live-up-to-their-claims-of-diversity-and-inclusion/">Better restroom access can help municipalities live up to their claims of diversity and inclusion</a> by Amith Saligrama
                </p>
              </li>
              <li>
                <p>
                  <b>NBC Boston (03/23/2023): </b> <a href="https://www.nbcboston.com/news/local/somerville-to-install-public-restrooms-as-limited-options-have-led-to-messes/3004952/">Somerville to Install Public Restrooms as Limited Options Have Led to Messes</a> by Bianca Beltrán
                </p>
              </li>
              <li>
                <p>
                  <b>Cambridge Day (10/12/22): </b> <a href="https://www.cambridgeday.com/2022/10/12/questions-on-embedding-teens-restroom-map-but-the-fact-is-when-you-gotta-go-you-gotta-go/">"Questions on embedding teen’s restroom map, but the fact is, when you gotta go, you gotta go"</a> by Marc Levy
                </p>
              </li>
              <li>
                <p>
                  <b>Axios Boston (08/17/22): </b> <a href="https://www.axios.com/local/boston/2022/08/17/boston-public-bathrooms">"Navigating Boston's public bathrooms"</a> by Steph Solis
                </p>
              </li>
              <li>
                <p>
                  <b>StreetsblogMASS (07/25/22): </b> <a href="https://mass.streetsblog.org/2022/07/25/public-bathroom-access-an-undervalued-but-necessary-element-of-walking-transit-infrastructure/">"Public Bathroom Access An Undervalued But Necessary Element of Walking, Transit Infrastructure"</a> by Grecia White
                </p>
              </li>
              <li>
                <p>
                  <b>Commonwealth School Newsletter (10/12/21): </b> <a href="https://www.commschool.org/news/news-post/~board/meet-our-students/post/where-to-go-one-students-quest-to-increase-bathroom-access">"Where to Go? One Student’s Quest to Increase Bathroom Access"</a>
                </p>
              </li>
            </ul>
            <h3>Feedback from users</h3>
            <ul>
              <li>“Thank you for you amazing work providing a map for accessible bathrooms. It is a tremendous resource for the many homeless clients I work with.”</li>
              <li>"Your website is great, you did a good job with it and you should feel proud!"</li>
              <li>"First of all thank you for compiling this resource. I have been looking for something like it and I am glad to see it. I have IBS so knowing where bathrooms are on short notice can be important for me."</li>
            </ul>
            <h3>Feedback from running/biking groups</h3>
            <ul>
              <li>"Thanks for sharing your public-restroom resource with us. We will keep this practical info in mind when suggesting cycling routes for our customers and club riders." - <b>Landry's Bicycles</b></li>
              <li>“This is really wonderful. Thanks so much for doing this.” - <b>Bike Rides for Ordinary People</b></li>
              <li>"Thank you very much for sending your awesome website to Cambridge Running Club! This will be a very helpful resource for runners! We will highlight it in our monthly newsletter. Great work!" - <b>Cambridge Running Club</b></li>
              <li>"We've passed it onto our community and appreciate you sending it across! Keep up the good work and stay awesome." - <b>Midnight Runners Community Support Team</b></li>
            </ul>
          </div>
          <div class="tab-pane fade" id="nav-resources" role="tabpanel" aria-labelledby="nav-resources-tab" tabindex="0">
            <br>
            <p>
              <a href="https://www.dropbox.com/s/j9sabtsoaxbgss1/BathroomAccessFlyer.pdf?dl=0">Flyer that explains how to use this site</a>
            </p>
            <p>
              <a href="https://www.youtube.com/watch?v=0TgtBOImVr0">Youtube video that explains how to use this site and how I coded it</a>
            </p>
            <p>I am happy to share data and resources with other community projects. Please email me at <a href="mailto:publicbathroomaccess@gmail.com">publicbathroomaccess@gmail.com</a> for access to an API or other data formats.</p>
          </div>
        </div>
      </div>
    </div>
  </div>
</body>
</html>
